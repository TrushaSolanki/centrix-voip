# Register and Login with 2FA Flow

## Step 1 - Register new user

```bash
curl --request POST --url https://api.centrixcc.com/users/register \
  --header 'Content-Type: application/json' \
  --data '{
  "email": "jhon_doe@gmail.com",
  "firstName": "Jhon",
  "lastName": "Doe",
  "password": "BestPassw0rdEver!",
  "confirmPassword": "BestPassw0rdEver!",
  "phoneNumber": "+1234567890",
  "accountName": "Company ABC, INC"
}'
```

## Step 2 - Confirm email

After registering, the user receives an email with a confirmation code. Use the confirmation code to confirm the email.

The email content must contain a link to the confirmation page. The confirmation page must call the /users/confirm-email endpoint with the confirmation code.

```bash
curl --request POST \
  --url https://api.centrixcc.com/users/confirm-email \
  --header 'Content-Type: application/json' \
  --data '{
  "Code": "<confirmation email code>"
}'
```

## Step 3 - First Login

```bash
curl --request POST --url https://api.centrixcc.com/users/login \
  --header 'Content-Type: application/json' \
  --data '{
  "email": "jhon_doe@gmail.com",
  "password": "BestPassw0rdEver!"
}'
```

## Step 4 - Generate 2FA secret

Call the /users/2fa endpoint, sending an empty JSON object ({}) in the request body.

```bash
curl --request POST --url https://api.centrixcc.com/users/2fa \
 --header 'Content-Type: application/json' \
 --header 'Authorization: Bearer <token>' \
 --data '{}'
```

The response body provides the SharedKey along with some other properties that aren't needed at this point. 
The shared key is used to set up the authenticator app. Response body example:

```json
{
  "sharedKey": "string",
  "recoveryCodesLeft": 0,
  "recoveryCodes": null,
  "isTwoFactorEnabled": false
}
```

Generate the QR Code using the shared key with some javascript library.

## Step 5 - Enable 2FA

Call the /users/2fa endpoint, sending the TOTP and "enable": true in the request body.

```bash
curl --request POST --url https://api.centrixcc.com/users/2fa \ 
  --header 'Authorization: Bearer <token>' \
  --data '{
  "enable": true,
  "twoFactorCode": "string"
}'
```

The response body confirms that IsTwoFactorEnabled is true and provides the RecoveryCodes. The recovery codes are used to log in when the authenticator app isn't available. Response body example after successfully enabling 2FA:

```json
{
  "sharedKey": "string",
  "recoveryCodesLeft": 10,
  "recoveryCodes": [
    "string",
    "string",
    "string",
    "string",
    "string",
    "string",
    "string",
    "string",
    "string",
    "string"
  ],
  "isTwoFactorEnabled": true
}
```

## Step 6 - Next Login

After enabling 2FA the user make a login request.

```bash
curl --request POST --url https://api.centrixcc.com/users/login \
  --cookie-jar ./cookies.txt \
  --header 'Content-Type: application/json' \
  --data '{
  "email": "jhon_doe@gmail.com",
  "password": "BestPassw0rdEver!"
}'
```

The response status code is 202 and a cookie is returned in the response headers. 
The cookie store the user id that is used to confirm the 2FA.

## Step 7 - Confirm login with 2FA Code

Call the api /users/login/2fa with the cookie created with the login api and the code generated by the authenticator app to confirm the 2FA.

```bash
curl --request POST --url https://api.centrixcc.com/users/login/2fa \
  --cookies ./cookies.txt \
  --header 'Content-Type: application/json' \
  --data '{
  "twoFactorCode": "123456"
}'
```

The response status code is 200 and the body contain a token that is used to authenticate the user in the next requests.

```json
{
  "tokenType": "Bearer",
  "accessToken": "string",
  "expiresIn": 3600,
  "refreshToken": "string"
}
```